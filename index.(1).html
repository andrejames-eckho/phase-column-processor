<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Phase Column Processor - Rita Analyzer & Smaart</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --brand-primary: #2563eb;
            --brand-secondary: #4f46e5;
        }

        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen',
                'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue',
                sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            background: linear-gradient(to bottom right, #0f172a, #1e293b, #0f172a);
            min-height: 100vh;
        }

        .container {
            min-height: 100vh;
            padding: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .main-card {
            max-width: 672px;
            width: 100%;
        }

        .card {
            background-color: #1e293b;
            border-radius: 16px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            border: 1px solid #334155;
            overflow: hidden;
        }

        .header {
            background: linear-gradient(to right, var(--brand-primary), var(--brand-secondary));
            padding: 24px;
        }

        .header-content {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .header-icon {
            width: 32px;
            height: 32px;
            color: white;
        }

        .header-title {
            font-size: 24px;
            font-weight: bold;
            color: white;
        }

        .header-subtitle {
            color: #dbeafe;
            font-size: 14px;
            margin-top: 4px;
        }

        .content {
            padding: 32px;
        }

        .upload-area {
            margin-bottom: 24px;
        }

        .upload-label {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 256px;
            border: 2px dashed #475569;
            border-radius: 12px;
            cursor: pointer;
            background-color: #334155;
            transition: all 0.2s;
        }

        .upload-label:hover {
            background-color: #3b4756;
            border-color: #2563eb;
        }

        .upload-label.file-selected {
            border-color: #10b981;
            background-color: rgba(16, 185, 129, 0.1);
        }

        .upload-icon {
            width: 64px;
            height: 64px;
            color: #94a3b8;
            margin-bottom: 16px;
        }

        .upload-text {
            font-size: 18px;
            font-weight: 600;
            color: #cbd5e1;
            margin-bottom: 8px;
        }

        .upload-subtext {
            font-size: 14px;
            color: #94a3b8;
        }

        .file-input {
            display: none;
        }

        .freq-section {
            margin-bottom: 24px;
            padding: 24px;
            background-color: #334155;
            border-radius: 8px;
            border: 1px solid #475569;
        }

        .checkbox-container {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
        }

        .checkbox {
            width: 16px;
            height: 16px;
            cursor: pointer;
        }

        .checkbox-label {
            color: #e2e8f0;
            font-weight: 600;
            cursor: pointer;
        }

        .freq-inputs {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-top: 16px;
            padding-left: 28px;
        }

        .input-group label {
            display: block;
            font-size: 14px;
            color: #94a3b8;
            margin-bottom: 8px;
        }

        .input-group input {
            width: 100%;
            padding: 8px 12px;
            background-color: #1e293b;
            border: 1px solid #475569;
            border-radius: 8px;
            color: #e2e8f0;
            font-size: 14px;
        }

        .input-group input:focus {
            outline: none;
            border-color: #2563eb;
        }

        .input-group input::placeholder {
            color: #64748b;
        }

        .hint-text {
            font-size: 12px;
            color: #94a3b8;
            margin-top: 12px;
            padding-left: 28px;
        }

        .alert {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 24px;
        }

        .alert-processing {
            background-color: rgba(30, 58, 138, 0.3);
            border: 1px solid #1e40af;
        }

        .alert-error {
            background-color: rgba(127, 29, 29, 0.3);
            border: 1px solid #991b1b;
        }

        .alert-success {
            background-color: rgba(20, 83, 45, 0.3);
            border: 1px solid #166534;
        }

        .alert-icon {
            width: 20px;
            height: 20px;
            flex-shrink: 0;
            margin-top: 2px;
        }

        .spinner {
            border: 2px solid transparent;
            border-top-color: #60a5fa;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .alert-processing .alert-text {
            color: #93c5fd;
        }

        .alert-error .alert-title {
            color: #fca5a5;
            font-weight: 600;
        }

        .alert-error .alert-text {
            color: #fecaca;
            font-size: 14px;
        }

        .alert-success .alert-title {
            color: #86efac;
            font-weight: 600;
        }

        .alert-success .alert-text {
            color: #bbf7d0;
            font-size: 14px;
            margin-top: 4px;
        }

        .info-section {
            margin-top: 32px;
            padding: 24px;
            background-color: #334155;
            border-radius: 8px;
            border: 1px solid #475569;
        }

        .info-title {
            font-weight: 600;
            color: #e2e8f0;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .info-icon {
            width: 20px;
            height: 20px;
            color: #60a5fa;
        }

        .info-list {
            list-style: none;
        }

        .info-list li {
            display: flex;
            align-items: flex-start;
            gap: 8px;
            font-size: 14px;
            color: #cbd5e1;
            margin-bottom: 8px;
        }

        .info-list li span {
            color: #60a5fa;
            font-weight: bold;
        }

        .button-group {
            display: flex;
            gap: 12px;
        }

        .btn {
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            border: none;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-size: 16px;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-primary {
            flex: 1;
            background: linear-gradient(to right, var(--brand-primary), var(--brand-secondary));
            color: white;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3);
        }

        .btn-primary:hover:not(:disabled) {
            opacity: 0.9;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.3);
        }

        .btn-secondary {
            padding: 12px 24px;
            background-color: #334155;
            color: #cbd5e1;
            border: 1px solid #475569;
        }

        .btn-secondary:hover:not(:disabled) {
            background-color: #475569;
        }

        .btn-icon {
            width: 20px;
            height: 20px;
        }

        .process-btn {
            width: 100%;
            margin-bottom: 24px;
        }

        .result-info {
            margin-top: 24px;
            padding: 16px;
            background-color: #334155;
            border-radius: 8px;
            border: 1px solid #475569;
        }

        .result-info p {
            color: #94a3b8;
            font-size: 14px;
            margin-bottom: 4px;
        }

        .result-filename {
            color: #e2e8f0;
            font-family: monospace;
            font-size: 14px;
        }

        .result-size {
            font-size: 12px;
            color: #64748b;
            margin-top: 8px;
        }

        .footer {
            text-align: center;
            margin-top: 24px;
        }

        .footer-text {
            color: #94a3b8;
            font-size: 14px;
        }

        .footer-subtext {
            color: #64748b;
            font-size: 12px;
            margin-top: 8px;
        }

        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="main-card">
            <div class="card">
                <div class="header">
                    <div class="header-content">
                        <svg class="header-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                            <polyline points="14 2 14 8 20 8"></polyline>
                            <line x1="16" y1="13" x2="8" y2="13"></line>
                            <line x1="16" y1="17" x2="8" y2="17"></line>
                            <polyline points="10 9 9 9 8 9"></polyline>
                        </svg>
                        <div>
                            <h1 class="header-title">Phase Column Processor</h1>
                            <p class="header-subtitle">Professional Audio Solutions</p>
                        </div>
                    </div>
                </div>

                <div class="content">
                    <div id="uploadSection">
                        <div class="upload-area">
                            <label for="file-upload" class="upload-label" id="uploadLabel">
                                <svg class="upload-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                    <polyline points="17 8 12 3 7 8"></polyline>
                                    <line x1="12" y1="3" x2="12" y2="15"></line>
                                </svg>
                                <p class="upload-text" id="uploadText">Click to upload file</p>
                                <p class="upload-subtext">.txt files only</p>
                                <input id="file-upload" type="file" class="file-input" accept=".txt">
                            </label>
                        </div>

                        <div class="freq-section">
                            <div class="checkbox-container">
                                <input type="checkbox" id="freq-range-toggle" class="checkbox">
                                <label for="freq-range-toggle" class="checkbox-label">
                                    Apply to specific frequency range only
                                </label>
                            </div>
                            
                            <div id="freqInputs" class="freq-inputs hidden">
                                <div class="input-group">
                                    <label>Min Frequency (Hz)</label>
                                    <input type="number" id="minFreq" placeholder="e.g., 100">
                                </div>
                                <div class="input-group">
                                    <label>Max Frequency (Hz)</label>
                                    <input type="number" id="maxFreq" placeholder="e.g., 10000">
                                </div>
                            </div>
                            
                            <p id="freqHint" class="hint-text hidden">
                                Leave fields empty to set no limit on that end
                            </p>
                        </div>

                        <button class="btn btn-primary process-btn" id="processBtn" disabled>
                            <svg class="btn-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <circle cx="12" cy="12" r="10"></circle>
                                <polyline points="16 12 12 8 8 12"></polyline>
                                <line x1="12" y1="16" x2="12" y2="8"></line>
                            </svg>
                            Process File
                        </button>

                        <div id="processingAlert" class="alert alert-processing hidden">
                            <div class="spinner"></div>
                            <span class="alert-text">Processing file...</span>
                        </div>

                        <div id="errorAlert" class="alert alert-error hidden">
                            <svg class="alert-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <circle cx="12" cy="12" r="10"></circle>
                                <line x1="12" y1="8" x2="12" y2="12"></line>
                                <line x1="12" y1="16" x2="12.01" y2="16"></line>
                            </svg>
                            <div>
                                <p class="alert-title">Error</p>
                                <p class="alert-text" id="errorText"></p>
                            </div>
                        </div>

                        <div class="info-section">
                            <h3 class="info-title">
                                <svg class="info-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                    <polyline points="14 2 14 8 20 8"></polyline>
                                    <line x1="16" y1="13" x2="8" y2="13"></line>
                                    <line x1="16" y1="17" x2="8" y2="17"></line>
                                    <polyline points="10 9 9 9 8 9"></polyline>
                                </svg>
                                How it works
                            </h3>
                            <ul class="info-list">
                                <li><span>1.</span> Upload your .txt file from Rita Analyzer or Smaart</li>
                                <li><span>2.</span> Optionally specify a frequency range to process</li>
                                <li><span>3.</span> Click "Process File" to zero the Phase column values</li>
                                <li><span>4.</span> Download the processed file with timestamp in the filename</li>
                            </ul>
                        </div>
                    </div>

                    <div id="resultSection" class="hidden">
                        <div class="alert alert-success">
                            <svg class="alert-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                                <polyline points="22 4 12 14.01 9 11.01"></polyline>
                            </svg>
                            <div>
                                <p class="alert-title">File processed successfully!</p>
                                <p class="alert-text" id="successText"></p>
                            </div>
                        </div>

                        <div class="button-group">
                            <button class="btn btn-primary" id="downloadBtn">
                                <svg class="btn-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                    <polyline points="7 10 12 15 17 10"></polyline>
                                    <line x1="12" y1="15" x2="12" y2="3"></line>
                                </svg>
                                Download Processed File
                            </button>
                            <button class="btn btn-secondary" id="resetBtn">
                                Process Another
                            </button>
                        </div>

                        <div class="result-info">
                            <p>Output filename:</p>
                            <p class="result-filename" id="resultFilename"></p>
                            <p class="result-size" id="resultSize"></p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="footer">
                <p class="footer-text">Compatible with Rita Analyzer and Smaart</p>
                <p class="footer-subtext">Powered by Eckho Systems</p>
            </div>
        </div>
    </div>

    <script>
        let uploadedFile = null;
        let fileContent = null;
        let processedContent = null;
        let processedFileName = null;

        const fileInput = document.getElementById('file-upload');
        const uploadLabel = document.getElementById('uploadLabel');
        const uploadText = document.getElementById('uploadText');
        const freqToggle = document.getElementById('freq-range-toggle');
        const freqInputs = document.getElementById('freqInputs');
        const freqHint = document.getElementById('freqHint');
        const minFreqInput = document.getElementById('minFreq');
        const maxFreqInput = document.getElementById('maxFreq');
        const processBtn = document.getElementById('processBtn');
        const processingAlert = document.getElementById('processingAlert');
        const errorAlert = document.getElementById('errorAlert');
        const errorText = document.getElementById('errorText');
        const uploadSection = document.getElementById('uploadSection');
        const resultSection = document.getElementById('resultSection');
        const successText = document.getElementById('successText');
        const downloadBtn = document.getElementById('downloadBtn');
        const resetBtn = document.getElementById('resetBtn');
        const resultFilename = document.getElementById('resultFilename');
        const resultSize = document.getElementById('resultSize');

        freqToggle.addEventListener('change', function() {
            if (this.checked) {
                freqInputs.classList.remove('hidden');
                freqHint.classList.remove('hidden');
            } else {
                freqInputs.classList.add('hidden');
                freqHint.classList.add('hidden');
            }
        });

        fileInput.addEventListener('change', async function(e) {
            const file = e.target.files[0];
            if (!file) return;

            if (!file.name.endsWith('.txt')) {
                showError('Please upload a .txt file');
                processBtn.disabled = true;
                return;
            }

            try {
                uploadedFile = file;
                fileContent = await file.text();
                uploadText.textContent = file.name;
                uploadLabel.classList.add('file-selected');
                processBtn.disabled = false;
                hideError();
            } catch (err) {
                showError('Failed to read file: ' + err.message);
                processBtn.disabled = true;
            }
        });

        processBtn.addEventListener('click', function() {
            if (!fileContent || !uploadedFile) {
                showError('Please upload a file first');
                return;
            }

            hideError();
            showProcessing();
            processBtn.disabled = true;

            // Use setTimeout to allow UI to update before processing
            setTimeout(() => {
                try {
                    const processed = processFile(fileContent);
                    
                    const now = new Date();
                    const dateStr = now.toISOString().slice(0, 10).replace(/-/g, '');
                    const timeStr = now.toTimeString().slice(0, 8).replace(/:/g, '');
                    const baseName = uploadedFile.name.replace('.txt', '');
                    const fileName = `${baseName}_phase0_${dateStr}_${timeStr}.txt`;

                    processedContent = processed;
                    processedFileName = fileName;

                    hideProcessing();
                    showResult();
                } catch (err) {
                    hideProcessing();
                    showError(err.message);
                    processBtn.disabled = false;
                }
            }, 100);
        });

        function processFile(content) {
            const lines = content.split('\n');
            const processedLines = [];
            let phaseColumnIndex = -1;
            let frequencyColumnIndex = -1;
            let headerProcessed = false;

            const useFreqRange = freqToggle.checked;
            const minFreq = minFreqInput.value ? parseFloat(minFreqInput.value) : null;
            const maxFreq = maxFreqInput.value ? parseFloat(maxFreqInput.value) : null;

            for (let i = 0; i < lines.length; i++) {
                const line = lines[i];
                
                if (!headerProcessed && line.includes('Phase')) {
                    const columns = line.split(/\t+|\s{2,}/);
                    phaseColumnIndex = columns.findIndex(col => 
                        col.trim().toLowerCase().includes('phase')
                    );
                    frequencyColumnIndex = columns.findIndex(col => {
                        const colName = col.trim().toLowerCase();
                        return colName.includes('freq') || colName.includes('hz') || colName === 'f';
                    });
                    if (frequencyColumnIndex === -1) {
                        frequencyColumnIndex = 0;
                    }
                    headerProcessed = true;
                    processedLines.push(line);
                    continue;
                }

                if (headerProcessed && phaseColumnIndex !== -1 && line.trim()) {
                    const columns = line.split(/\t+|\s{2,}/);
                    
                    if (columns.length > phaseColumnIndex) {
                        let shouldZeroPhase = true;

                        if (useFreqRange && (minFreq !== null || maxFreq !== null)) {
                            const frequency = parseFloat(columns[frequencyColumnIndex]);
                            
                            if (!isNaN(frequency)) {
                                shouldZeroPhase = true;
                                if (minFreq !== null && frequency < minFreq) {
                                    shouldZeroPhase = false;
                                }
                                if (maxFreq !== null && frequency > maxFreq) {
                                    shouldZeroPhase = false;
                                }
                            }
                        }

                        if (shouldZeroPhase) {
                            columns[phaseColumnIndex] = '0';
                        }
                        processedLines.push(columns.join('\t'));
                    } else {
                        processedLines.push(line);
                    }
                } else {
                    processedLines.push(line);
                }
            }

            return processedLines.join('\n');
        }

        function showProcessing() {
            processingAlert.classList.remove('hidden');
        }

        function hideProcessing() {
            processingAlert.classList.add('hidden');
        }

        function showError(message) {
            errorText.textContent = message;
            errorAlert.classList.remove('hidden');
        }

        function hideError() {
            errorAlert.classList.add('hidden');
        }

        function showResult() {
            const useFreqRange = freqToggle.checked;
            const minFreq = minFreqInput.value || '0';
            const maxFreq = maxFreqInput.value || 'âˆž';
            
            if (useFreqRange && (minFreqInput.value || maxFreqInput.value)) {
                successText.textContent = `Phase column zeroed for ${minFreq} Hz to ${maxFreq} Hz`;
            } else {
                successText.textContent = 'All Phase column values have been set to 0';
            }

            resultFilename.textContent = processedFileName;
            resultSize.textContent = `Content size: ${(processedContent.length / 1024).toFixed(1)} KB`;

            uploadSection.classList.add('hidden');
            resultSection.classList.remove('hidden');
        }

        downloadBtn.addEventListener('click', function() {
            const blob = new Blob([processedContent], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = processedFileName;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        });

        resetBtn.addEventListener('click', function() {
            uploadedFile = null;
            fileContent = null;
            processedContent = null;
            processedFileName = null;
            fileInput.value = '';
            uploadText.textContent = 'Click to upload file';
            uploadLabel.classList.remove('file-selected');
            minFreqInput.value = '';
            maxFreqInput.value = '';
            freqToggle.checked = false;
            freqInputs.classList.add('hidden');
            freqHint.classList.add('hidden');
            processBtn.disabled = true;
            hideError();
            uploadSection.classList.remove('hidden');
            resultSection.classList.add('hidden');
        });
    </script>
</body>
</html>